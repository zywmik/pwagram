"use strict";function _createForOfIteratorHelper(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=_unsupportedIterableToArray(e))){var t=0,n=function(){};return{s:n,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a,r=!0,i=!1;return{s:function(){o=e[Symbol.iterator]()},n:function(){var e=o.next();return r=e.done,e},e:function(e){i=!0,a=e},f:function(){try{r||null==o.return||o.return()}finally{if(i)throw a}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}var picture,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader"),fetchedLocation={lat:0,lng:0};function initializeLocation(){"geolocation"in navigator||(locationBtn.style.display="none")}function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(n){var o=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return o?new Promise(function(e,t){o.call(navigator,n,e,t)}):Promise.reject(new Error("getUserMedia is not implemented"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(function(e){imagePickerArea.style.display="block"})}function openCreatePostModal(){setTimeout(function(){createPostArea.style.transform="translateY(0)"},1),initializeMedia(),initializeLocation(),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")}),deferredPrompt=null)}function closeCreatePostModal(){imagePickerArea.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="none",locationBtn.style.display="inline",locationLoader.style.display="none",captureButton.style.display="inline",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),setTimeout(function(){createPostArea.style.transform="translateY(100vh)"},1)}locationBtn.addEventListener("click",function(e){if("geolocation"in navigator){var t=!1;locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(function(e){if(locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={lat:e.coords.latitude,lng:e.coords.longitude},process.env.GKEY)fetch("https://maps.googleapis.com/maps/api/geocode/json?latlng=".concat(fetchedLocation.lat,",").concat(fetchedLocation.lng,"&key=").concat(process.env.GKEY)).then(function(e){return e.json()}).then(function(e){locationInput.value=e.results[4].formatted_address||""}).catch(function(e){return console.error(e)});else locationInput.value="Please, insert location manually...";document.querySelector("#manual-location").classList.add("is-focused")},function(e){console.log(e),locationBtn.style.display="inline",locationLoader.style.display="none",t||(alert("Couldn't fetch location, please enter it manually!"),t=!0),fetchedLocation={lat:0,lng:0}},{timeout:7e3,enableHighAccuracy:!0})}}),captureButton.addEventListener("click",function(e){canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvas.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvas.width)),videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",function(e){picture=e.target.files[0]});var onSaveButtonClicked=function(){console.log("clicked"),"caches"in window&&caches.open("user-requested").then(function(e){e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")})};shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var clearCards=function(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)};function createCard(e){var t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp";var n=document.createElement("div");n.className="mdl-card__title",n.style.backgroundImage="url(".concat(e.image,")"),n.style.backgroundSize="cover",t.appendChild(n);var o=document.createElement("h2");o.style.color="white",o.className="mdl-card__title-text",o.textContent=e.title,n.appendChild(o);var a=document.createElement("div");a.className="mdl-card__supporting-text",a.textContent=e.location,a.style.textAlign="center",t.appendChild(a),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){var t,n=_createForOfIteratorHelper(e);try{for(n.s();!(t=n.n()).done;){createCard(t.value)}}catch(e){n.e(e)}finally{n.f()}}var url="https://pwagram-30612.firebaseio.com/posts.json",networkDataReceived=!1;function sendData(){var e=(new Date).toISOString(),t=new FormData;t.append("id",e),t.append("title",titleInput.value),t.append("location",locationInput.value),t.append("rawLocationLat",fetchedLocation.lat),t.append("rawLocationLng",fetchedLocation.lng),t.append("file",picture,"".concat(e,".png")),fetch("https://us-central1-pwagram-30612.cloudfunctions.net/storePostData",{method:"POST",body:t}).then(function(e){console.log("Sent data",e),updateUI()})}fetch(url).then(function(e){return e.json()}).then(function(e){console.log("From web: ",e),networkDataReceived=!0;var t=[];for(var n in e)t.push(e[n]);clearCards(),updateUI(t)}),"indexedDB"in window&&readAllData("posts").then(function(e){networkDataReceived||(console.log("From cache: ",e),updateUI(e))}),form.addEventListener("submit",function(e){e.preventDefault(),""!==titleInput.value.trim()&&""!==locationInput.value.trim()?(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,picture:picture,rawLocation:fetchedLocation};writeData("sync-posts",t).then(function(){return e.sync.register("sync-new-posts")}).then(function(){document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Your Post was saved for syncing!"})}).catch(function(e){console.log(e)})}):sendData()):alert("Please enter valid data!")});